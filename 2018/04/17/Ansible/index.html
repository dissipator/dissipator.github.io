<!DOCTYPE html>
<html class="full-height">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="//cdn.bootcss.com/bulma/0.4.1/css/bulma.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  
  <title>Ansible | Lucas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ansible使用记录Ansible 安装教程ansible 的安装轻而易举，许多发行版的第三方软件仓库中都有现成的软件包，可以直接安装。其他简单的安装方法包括使用 pip 安装它，或者从 github 里获取最新的版本。若想使用你的软件包管理器安装，在基于 RHEL/CentOS Linux 的系统里你很可能需要 EPEL 仓库。 在基于 RHEL/CentOS Linux 的系统中安装 ans">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible">
<meta property="og:url" content="https://dissipator.github.io/2018/04/17/Ansible/index.html">
<meta property="og:site_name" content="Lucas">
<meta property="og:description" content="ansible使用记录Ansible 安装教程ansible 的安装轻而易举，许多发行版的第三方软件仓库中都有现成的软件包，可以直接安装。其他简单的安装方法包括使用 pip 安装它，或者从 github 里获取最新的版本。若想使用你的软件包管理器安装，在基于 RHEL/CentOS Linux 的系统里你很可能需要 EPEL 仓库。 在基于 RHEL/CentOS Linux 的系统中安装 ans">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-04-26T04:49:30.476Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ansible">
<meta name="twitter:description" content="ansible使用记录Ansible 安装教程ansible 的安装轻而易举，许多发行版的第三方软件仓库中都有现成的软件包，可以直接安装。其他简单的安装方法包括使用 pip 安装它，或者从 github 里获取最新的版本。若想使用你的软件包管理器安装，在基于 RHEL/CentOS Linux 的系统里你很可能需要 EPEL 仓库。 在基于 RHEL/CentOS Linux 的系统中安装 ans">
  
    <link rel="alternate" href="/atom.xml" title="Lucas" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/css/nav.css">
<link rel="stylesheet" href="/css/layout.css">
  

</head>

<body>
  <header id="navbar" class="overflow-hidden">
  <div class="container">
    <nav class="nav">
         <div class="nav-left">
            <a href="/" class="nav-item" style="font-size: 20px;">
              <span class="logo">Lucas</span>'s Blog
            </a>
         </div>
        <div class="nav-center is-hidden position-relative" id="search_container">
            <div class="nav-item full-width full-height">
                <i class="fa fa-search has-padding" aria-hidden="true"></i>
                <input type="text" id="search_input" class="search-input full-height full-width" placeholder="Search post" autofocus>
                <i id="close_search" class="fa fa-times" aria-hidden="true"></i>
            </div>
            <div id="search_result"></div>
        </div>
        <div class="nav-right nav-menu">
            <a class="nav-item" id="search">
                <i class="fa fa-search" aria-hidden="true"></i>
            </a>
            
            <a class="nav-item" href="/">
                Home
            </a>
            
            <a class="nav-item" href="/about">
                About
            </a>
            
            <a class="nav-item" href="/tags">
                Tags
            </a>
            
        </div>
        <span class="nav-toggle" id="navMenuDropdown">
            <span></span>
            <span></span>
            <span></span>
        </span>
        <div class="navbar-menu position-absolute full-width content-box is-hidden-desktop is-flex flex-column center" style="top: 100%;">
            
            <a class="nav-item flex-1" href="/">
                Home
            </a>
            
            <a class="nav-item flex-1" href="/about">
                About
            </a>
            
            <a class="nav-item flex-1" href="/tags">
                Tags
            </a>
            
        </div>
    </nav>
  </div>
</header>

  <div id="main-wrap" class="position-relative" style="margin-top: 55px;">
      <div class="main-inner-content">
          <!--博文页面-->

<style>
    .header-box {
        height: 370px;
        filter: blur(10px);
        background-size: cover;
        background-color: lightsteelblue;
    }

    .post-box {
        padding: 15px;
        padding-top: 60px;
        min-height: 80vh;
        margin-top: -200px;
        border-radius: 4px;
        background-color: rgba(255,255,255,.8);
    }

    .post-avatar {
        height: 30px;
        width: 30px;
        border-radius: 50%;
    }

    .flow-chart {
        text-align: center;
    }

    img[alt="post-cover"] {
        display: none;
    }
</style>
<header>
    <div id="header_box" class="header-box"></div>
</header>
<section>
    <div class="container post-box">
        <div class="content post-title is-flex center flex-column" style="margin-bottom: 70px; overflow: auto;">
            <h1 class="has-text-centered" style="padding-bottom: 10px; border-bottom: 3px solid #fff">
                <strong>Ansible</strong>
            </h1>
            
            <div class="is-flex align-center">
                <img class="post-avatar" src="https://cdn2.iconfinder.com/data/icons/rcons-user/32/male-shadow-circle-512.png">
                <span style="padding:0 10px;"> <span class="sub-title">By</span> Lucas</span>
                <span class="post-date sub-title">at: 2018-04-17</span>
            </div>
            
                <div>
                    
                </div>
            
        </div>
        <div class="content" style="overflow: auto">
            <h1 id="ansible使用记录"><a href="#ansible使用记录" class="headerlink" title="ansible使用记录"></a>ansible使用记录</h1><h3 id="Ansible-安装教程"><a href="#Ansible-安装教程" class="headerlink" title="Ansible 安装教程"></a><strong>Ansible 安装教程</strong></h3><p>ansible 的安装轻而易举，许多发行版的第三方软件仓库中都有现成的软件包，可以直接安装。其他简单的安装方法包括使用 pip 安装它，或者从 github 里获取最新的版本。若想使用你的软件包管理器安装，在<a href="http://www.cyberciti.biz/faq/fedora-sl-centos-redhat6-enable-epel-repo/" target="_blank" rel="noopener">基于 RHEL/CentOS Linux 的系统里你很可能需要 EPEL 仓库</a>。</p>
<h4 id="在基于-RHEL-CentOS-Linux-的系统中安装-ansible"><a href="#在基于-RHEL-CentOS-Linux-的系统中安装-ansible" class="headerlink" title="在基于 RHEL/CentOS Linux 的系统中安装 ansible"></a>在基于 RHEL/CentOS Linux 的系统中安装 ansible</h4><p>输入如下 <a href="http://www.cyberciti.biz/faq/rhel-centos-fedora-linux-yum-command-howto/" target="_blank" rel="noopener">yum 命令</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install ansible</span><br></pre></td></tr></table></figure>
<h4 id="在基于-Debian-Ubuntu-Linux-的系统中安装-ansible"><a href="#在基于-Debian-Ubuntu-Linux-的系统中安装-ansible" class="headerlink" title="在基于 Debian/Ubuntu Linux 的系统中安装 ansible"></a>在基于 Debian/Ubuntu Linux 的系统中安装 ansible</h4><p>输入如下 <a href="http://www.cyberciti.biz/tips/linux-debian-package-management-cheat-sheet.html" target="_blank" rel="noopener">apt-get 命令</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install software-properties-common$ sudo apt-add-repository ppa:ansible/ansible$ sudo apt-get update$ sudo apt-get install ansible</span><br></pre></td></tr></table></figure>
<h4 id="使用-pip-安装-ansible"><a href="#使用-pip-安装-ansible" class="headerlink" title="使用 pip 安装 ansible"></a>使用 pip 安装 ansible</h4><p><a href="http://www.cyberciti.biz/faq/debian-ubuntu-centos-rhel-linux-install-pipclient/" target="_blank" rel="noopener">pip 命令是一个安装和管理 Python 软件包的工具</a>，比如它能管理 Python Package Index 中的那些软件包。如下方式在 Linux 和类 Unix 系统中通用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install ansible</span><br></pre></td></tr></table></figure>
<h4 id="从源代码安装最新版本的-ansible"><a href="#从源代码安装最新版本的-ansible" class="headerlink" title="从源代码安装最新版本的 ansible"></a>从源代码安装最新版本的 ansible</h4><p>你可以通过如下命令从 github 中安装最新版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~$ git clone git://github.com/ansible/ansible.git$ cd ./ansible$ source ./hacking/env-setup</span><br></pre></td></tr></table></figure>
<p>当你从一个 git checkout 中运行 ansible 的时候，请记住你每次用它之前都需要设置你的环境，或者你可以把这个设置过程加入你的 bash rc 文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 加入 BASH RC$ echo &quot;export ANSIBLE_HOSTS=~/ansible_hosts&quot; &gt;&gt; ~/.bashrc$ echo &quot;source ~/ansible/hacking/env-setup&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>ansible 的 hosts 文件包括了一系列它能操作的主机。默认情况下 ansible 通过路径 /etc/ansible/hosts 查找 hosts 文件，不过这个行为也是可以更改的，这样当你想操作不止一个 ansible 或者针对不同的数据中心的不同客户操作的时候也是很方便的。你可以通过命令行参数 -i 指定 hosts 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m shell -a &quot;hostname&quot; --ask-pass -i /etc/some/other/dir/ansible_hosts</span><br></pre></td></tr></table></figure>
<p>不过我更倾向于使用一个环境变量，这可以在你想要通过 source 一个不同的文件来切换工作目标的时候起到作用。这里的环境变量是 $ANSIBLE_HOSTS，可以这样设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export ANSIBLE_HOSTS=~/ansible_hosts</span><br></pre></td></tr></table></figure>
<p>一旦所有需要的组件都已经安装完毕，而且你也准备好了你的 hosts 文件，你就可以来试一试它了。为了快速测试，这里我把 127.0.0.1 写到了 ansible 的 hosts 文件里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;127.0.0.1&quot; &gt; ~/ansible_hosts</span><br></pre></td></tr></table></figure>
<p>现在来测试一个简单的 ping：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m ping</span><br></pre></td></tr></table></figure>
<p>或者提示 ssh 密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m ping --ask-pass</span><br></pre></td></tr></table></figure>
<p>我在刚开始的设置中遇到过几次问题，因此这里强烈推荐为 ansible 设置 SSH 公钥认证。不过在刚刚的测试中我们使用了 –ask-pass，在一些机器上你会需要<a href="http://www.cyberciti.biz/faq/noninteractive-shell-script-ssh-password-provider/" target="_blank" rel="noopener">安装 sshpass</a> 或者像这样指定 -c paramiko：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m ping --ask-pass -c paramiko</span><br></pre></td></tr></table></figure>
<p>当然你也可以<a href="http://www.cyberciti.biz/faq/noninteractive-shell-script-ssh-password-provider/" target="_blank" rel="noopener">安装 sshpass</a>，然而 sshpass 并不总是在标准的仓库中提供，因此 paramiko 可能更为简单。</p>
<h3 id="设置-SSH-公钥认证"><a href="#设置-SSH-公钥认证" class="headerlink" title="设置 SSH 公钥认证"></a>设置 SSH 公钥认证</h3><p>于是我们有了一份配置，以及一些基础的其他东西。现在让我们来做一些实用的事情。ansible 的强大很大程度上体现在 playbooks 上，后者基本上就是一些写好的 ansible 脚本（大部分来说），不过在制作一个 playbook 之前，我们将先从一些一句话脚本开始。现在让我们创建和配置 SSH 公钥认证，以便省去 -c 和 –ask-pass 选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
<p>现在显然有很多种方式来把它放到远程主机上应该的位置。不过既然我们正在使用 ansible，就用它来完成这个操作吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m copy -a &quot;src=/home/xxx/.ssh/id_rsa.pub dest=/tmp/id_rsa.pub&quot; --ask-pass -c paramiko</span><br></pre></td></tr></table></figure>
<p>下一步，把公钥文件添加到远程服务器里。输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m shell -a &quot;cat /tmp/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys&quot; --ask-pass -c paramiko</span><br></pre></td></tr></table></figure>
<p>样例输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSH password:127.0.0.1 | FAILED | rc=1 &gt;&gt;/bin/sh: /root/.ssh/authorized_keys: Permission denied</span><br></pre></td></tr></table></figure>
<p>矮油，我们需要用 root 来执行这个命令，所以还是加上一个 -u 参数吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m shell -a &quot;cat /tmp/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys&quot; --ask-pass -c paramiko -u root</span><br></pre></td></tr></table></figure>
<p>样例输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSH password:127.0.0.1 | success | rc=0 &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>请注意，我刚才这是想要演示通过 ansible 来传输文件的操作。事实上 ansible 有一个更加方便的内置 SSH 密钥管理支持：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m authorized_key -a &quot;user=xxx key=&apos;&#123;&#123; lookup(&apos;file&apos;, &apos;/home/xxx/.ssh/id_rsa.pub&apos;) &#125;&#125;&apos; path=/home/xxx/.ssh/authorized_keys manage_dir=no&quot; --ask-pass -c paramiko</span><br></pre></td></tr></table></figure>
<p>现在这些密钥已经设置好了。我们来试着随便跑一个命令，比如 hostname，希望我们不会被提示要输入密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m shell -a &quot;hostname&quot; -u root</span><br></pre></td></tr></table></figure>
<p>样例输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 | success | rc=0 &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>成功！！！现在我们可以用 root 来执行命令，并且不会被输入密码的提示干扰了。我们现在可以轻易地配置任何在 ansible hosts 文件中的主机了。让我们把 /tmp 中的公钥文件删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m file -a &quot;dest=/tmp/id_rsa.pub state=absent&quot; -u root</span><br></pre></td></tr></table></figure>
<p>样例输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 | success &gt;&gt; &#123;    &quot;changed&quot;: true,    &quot;path&quot;: &quot;/tmp/id_rsa.pub&quot;,    &quot;state&quot;: &quot;absent&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来做一些更复杂的事情，我要确定一些软件包已经安装了，并且已经是最新的版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m zypper -a &quot;name=apache2 state=latest&quot; -u root</span><br></pre></td></tr></table></figure>
<p>样例输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 | success &gt;&gt; &#123;    &quot;changed&quot;: false,    &quot;name&quot;: &quot;apache2&quot;,    &quot;state&quot;: &quot;latest&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>很好，我们刚才放在 /tmp 中的公钥文件已经消失了，而且我们已经安装好了最新版的 apache。下面我们来看看前面命令中的 -m zypper，一个让 ansible 非常灵活，并且给了 playbooks 更多能力的功能。如果你不使用 openSuse 或者 Suse enterprise 你可能还不熟悉 zypper, 它基本上就是 suse 世界中相当于 yum 的存在。在上面所有的例子中，我的 hosts 文件中都只有一台机器。除了最后一个命令外，其他所有命令都应该在任何标准的 *nix 系统和标准的 ssh 配置中使用，这造成了一个问题。如果我们想要同时管理多种不同的机器呢？这便是 playbooks 和 ansible 的可配置性闪闪发光的地方了。首先我们来少许修改一下我们的 hosts 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/ansible_hosts</span><br></pre></td></tr></table></figure>
<p>样例输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[RHELBased]121.12.12.12</span><br><span class="line">[SUSEBased]127.0.0.1</span><br></pre></td></tr></table></figure>
<p>首先，我们创建了一些分组的服务器，并且给了他们一些有意义的标签。然后我们来创建一个为不同类型的服务器执行不同操作的 playbook。你可能已经发现这个 yaml 的数据结构和我们之前运行的命令行语句中的相似性了。简单来说，-m 是一个模块，而 -a 用来提供模块参数。在 YAML 表示中你可以先指定模块，然后插入一个冒号 :，最后指定参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: SUSEBased  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- zypper: </span><br><span class="line">name=apache2 </span><br><span class="line">state=latest</span><br><span class="line">- hosts: RHELBased  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- yum: </span><br><span class="line">name=httpd </span><br><span class="line">state=latest</span><br></pre></td></tr></table></figure>
<p>现在我们有一个简单的 playbook 了，我们可以这样运行它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook testPlaybook.yaml -f 10</span><br></pre></td></tr></table></figure>
<p>注意，你会看到 ansible 联系到的每一台机器的输出。-f 参数让 ansible 在多台主机上同时运行指令。除了指定全部主机，或者一个主机分组的名字以外，你还可以把导入 ssh 公钥的操作从命令行里转移到 playbook 中，这将在设置新主机的时候提供很大的方便，甚至让新主机直接可以运行一个 playbook。为了演示，我们把我们之前的公钥例子放进一个 playbook 里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: SUSEBased  </span><br><span class="line">remote_user: xxx  </span><br><span class="line">sudo: yes  </span><br><span class="line">tasks:    </span><br><span class="line">- authorized_key: </span><br><span class="line">user=root </span><br><span class="line">key=&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/home/xxx/.ssh/id_rsa.pub&apos;) &#125;&#125;&quot; path=/root/.ssh/authorized_keys </span><br><span class="line">manage_dir=no</span><br><span class="line">- hosts: RHELBased</span><br><span class="line">remote_user: aaa  </span><br><span class="line">sudo: yes  </span><br><span class="line">tasks:    </span><br><span class="line">- authorized_key: </span><br><span class="line">user=root </span><br><span class="line">key=&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/home/xxx/.ssh/id_rsa.pub&apos;) &#125;&#125;&quot; path=/root/.ssh/authorized_keys </span><br><span class="line">manage_dir=no</span><br></pre></td></tr></table></figure>
<p>除此之外还有很多可以做的事情，比如在启动的时候把公钥配置好，或者引入其他的流程来让你按需配置一些机器。不过只要 SSH 被配置成接受密码登陆，这些几乎可以用在所有的流程中。在你准备开始写太多 playbook 之前，另一个值得考虑的事情是，代码管理可以有效节省你的时间。机器需要不断变化，然而你并不需要在每次机器发生变化时都重新写一个 playbook，只需要更新相关的部分并提交这些修改。与此相关的另一个好处是，如同我之前所述，你可以从不同的地方管理你的整个基础结构。你只需要将你的 playbook 仓库 git clone 到新的机器上，就完成了管理所有东西的全部设置流程。</p>
<h3 id="现实中的-ansible-例子"><a href="#现实中的-ansible-例子" class="headerlink" title="现实中的 ansible 例子"></a>现实中的 ansible 例子</h3><p>我知道很多用户经常使用 pastebin 这样的服务，以及很多公司基于显而易见的理由配置了他们内部使用的类似东西。最近，我遇到了一个叫做 showterm 的程序，巧合之下我被一个客户要求配置它用于内部使用。这里我不打算赘述这个应用程序的细节，不过如果你感兴趣的话，你可以使用 Google 搜索 showterm。作为一个合理的现实中的例子，我将会试图配置一个 showterm 服务器，并且配置使用它所需要的客户端应用程序。在这个过程中我们还需要一个数据库服务器。现在我们从配置客户端开始：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: showtermClients  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- yum: </span><br><span class="line">name=rubygems </span><br><span class="line">state=latest    </span><br><span class="line">- yum: </span><br><span class="line">name=ruby-devel </span><br><span class="line">state=latest    </span><br><span class="line">- yum: </span><br><span class="line">name=gcc </span><br><span class="line">state=latest    </span><br><span class="line">- gem: </span><br><span class="line">name=showterm </span><br><span class="line">state=latest </span><br><span class="line">user_install=no</span><br></pre></td></tr></table></figure>
<p>这部分很简单。下面是主服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: showtermServers  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- </span><br><span class="line">name: </span><br><span class="line">ensure packages are installed      </span><br><span class="line">yum: </span><br><span class="line">name=&#123;&#123;item&#125;&#125; </span><br><span class="line">state=latest      </span><br><span class="line">with_items:        </span><br><span class="line">- postgresql        </span><br><span class="line">- postgresql-server        </span><br><span class="line">- postgresql-devel        </span><br><span class="line">- python-psycopg2        </span><br><span class="line">- git        </span><br><span class="line">- ruby21        </span><br><span class="line">- ruby21-passenger   </span><br><span class="line">- name: </span><br><span class="line">showterm server from github      </span><br><span class="line">git: </span><br><span class="line">repo=https://github.com/ConradIrwin/showterm.io dest=/root/showterm</span><br><span class="line">- name: </span><br><span class="line">Initdb      </span><br><span class="line">command: service postgresql initdb               creates=/var/lib/pgsql/data/postgresql.conf     </span><br><span class="line">- name: </span><br><span class="line">Start PostgreSQL and enable at boot      </span><br><span class="line">service: </span><br><span class="line">name=postgresql               </span><br><span class="line">enabled=yes               </span><br><span class="line">state=started    </span><br><span class="line">- gem: </span><br><span class="line">name=pg </span><br><span class="line">state=latest </span><br><span class="line">user_install=no  </span><br><span class="line">handlers:   </span><br><span class="line">- name: restart postgresql     </span><br><span class="line">service: </span><br><span class="line">name=postgresql </span><br><span class="line">state=restarted </span><br><span class="line">- hosts: showtermServers  </span><br><span class="line">remote_user: root  </span><br><span class="line">sudo: yes  </span><br><span class="line">sudo_user: postgres  </span><br><span class="line">vars:    </span><br><span class="line">dbname: showterm    </span><br><span class="line">dbuser: showterm    </span><br><span class="line">dbpassword: showtermpassword  </span><br><span class="line">tasks:    </span><br><span class="line">- name: create db      </span><br><span class="line">postgresql_db: </span><br><span class="line">name=&#123;&#123;dbname&#125;&#125;     </span><br><span class="line">- name: create user with ALL priv      </span><br><span class="line">postgresql_user: </span><br><span class="line">db=&#123;&#123;dbname&#125;&#125; </span><br><span class="line">name=&#123;&#123;dbuser&#125;&#125; </span><br><span class="line">password=&#123;&#123;dbpassword&#125;&#125; </span><br><span class="line">priv=ALL</span><br><span class="line">- hosts: showtermServers  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- name: database.yml      </span><br><span class="line">template: </span><br><span class="line">src=database.yml </span><br><span class="line">dest=/root/showterm/config/database.yml</span><br><span class="line">- hosts: showtermServers  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- name: run bundle install      </span><br><span class="line">shell: bundle install      </span><br><span class="line">args:        </span><br><span class="line">chdir: /root/showterm</span><br><span class="line">- hosts: showtermServers  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- name: run rake db tasks      </span><br><span class="line">shell: &apos;bundle exec rake db:create db:migrate db:seed&apos;      args:</span><br><span class="line">chdir: /root/showterm</span><br><span class="line">- hosts: showtermServers  </span><br><span class="line">remote_user: root  </span><br><span class="line">tasks:    </span><br><span class="line">- name: apache config      </span><br><span class="line">template: </span><br><span class="line">src=showterm.conf </span><br><span class="line">dest=/etc/httpd/conf.d/showterm.conf</span><br></pre></td></tr></table></figure>
<p>还凑合。请注意，从某种意义上来说这是一个任意选择的程序，然而我们现在已经可以持续地在任意数量的机器上部署它了，这便是配置管理的好处。此外，在大多数情况下这里的定义语法几乎是不言而喻的，wiki 页面也就不需要加入太多细节了。当然在我的观点里，一个有太多细节的 wiki 页面绝不会是一件坏事。</p>
<h3 id="扩展配置"><a href="#扩展配置" class="headerlink" title="扩展配置"></a>扩展配置</h3><p>我们并没有涉及到这里所有的细节。Ansible 有许多选项可以用来配置你的系统。你可以在你的 hosts 文件中内嵌变量，而 ansible 将会把它们应用到远程节点。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[RHELBased]</span><br><span class="line">9.9.9.9.  http_port=443 </span><br><span class="line">8.8.8.8   http_port=80  ansible_ssh_user=mdonlon </span><br><span class="line">[SUSEBased]</span><br><span class="line">127.0.0.1  http_port=443</span><br></pre></td></tr></table></figure>
<p>尽管这对于快速配置来说已经非常方便，你还可以将变量分成存放在 yaml 格式的多个文件中。在你的 hosts 文件路径里，你可以创建两个子目录 group<em>vars 和 host</em>vars。在这些路径里放置的任何文件，只要能对得上一个主机分组的名字，或者你的 hosts 文件中的一个主机名，它们都会在运行时被插入进来。所以前面的一个例子将会变成这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ultrabook:/etc/ansible # pwd</span><br><span class="line">/etc/ansible</span><br><span class="line">ultrabook:/etc/ansible # tree.</span><br><span class="line">├── group_vars</span><br><span class="line">│   ├── RHELBased</span><br><span class="line">│   └── SUSEBased</span><br><span class="line">├── hosts</span><br><span class="line">└── host_vars</span><br><span class="line">    ├── 10.50.1.33</span><br><span class="line">    └── 10.50.1.47</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2 directories, 5 files</span><br><span class="line">ultrabook:/etc/ansible # cat hosts</span><br><span class="line">[RHELBased]</span><br><span class="line">10.50.1.33</span><br><span class="line">10.50.1.47</span><br><span class="line">[SUSEBased]</span><br><span class="line">127.0.0.1</span><br><span class="line">ultrabook:/etc/ansible # cat group_vars/RHELBased</span><br><span class="line">ultrabook:/etc/ansible # cat group_vars/SUSEBased</span><br><span class="line">---</span><br><span class="line">http_port: 443</span><br><span class="line">ultrabook:/etc/ansible # cat host_vars/10.50.1.33</span><br><span class="line">---</span><br><span class="line">http_port: 443</span><br><span class="line">ultrabook:/etc/ansible # cat host_vars/10.50.1.47</span><br><span class="line">---</span><br><span class="line">http_port:80</span><br><span class="line">ansible_ssh_user: mdonlon</span><br></pre></td></tr></table></figure>
<h3 id="改善-Playbooks"><a href="#改善-Playbooks" class="headerlink" title="改善 Playbooks"></a>改善 Playbooks</h3><p>组织 playbooks 也已经有很多种现成的方式。在前面的例子中我们用了一个单独的文件，因此这方面被大幅地简化了。组织这些文件的一个常用方式是创建角色。简单来说，你将一个主文件加载为你的 playbook，而它将会从其它文件中导入所有的数据，这些其他的文件便是角色。举例来说，如果你有了一个 wordpress 网站，你需要一个 web 前端，和一个数据库。web 前端将包括一个 web 服务器，应用程序代码，以及任何需要的模块。数据库有时候运行在同一台主机上，有时候运行在远程的主机上，这时候角色就可以派上用场了。你创建一个目录，并对每个角色创建对应的小 playbook。在这个例子中我们需要一个 apache 角色，mysql 角色，wordpress 角色，mod_php，以及 php 角色。最大的好处是，并不是每个角色都必须被应用到同一台机器上。在这个例子中，mysql 可以被应用到一台单独的机器。这同样为代码重用提供了可能，比如你的 apache 角色还可以被用在 python 和其他相似的 php 应用程序中。展示这些已经有些超出了本文的范畴，而且做一件事总是有很多不同的方式，我建议搜索一些 ansible 的 playbook 例子。有很多人在 github 上贡献代码，当然还有其他一些网站。</p>
<h2 id="ansible命令集："><a href="#ansible命令集：" class="headerlink" title="ansible命令集："></a>ansible命令集：</h2><p>/usr/bin/ansible: # Ansibe AD-Hoc 临时命令执行工具，常用于临时命令的执行<br>/usr/bin/ansible-doc: # Ansible 模块功能查看工具<br>/usr/bin/ansible-galaxy: # 下载/上传优秀代码或Roles模块的官网平台，基于网络的<br>/usr/bin/ansible-playbook: # Ansible 定制自动化的任务集编排工具<br>/usr/bin/ansible-pull: # Ansible远程执行命令的工具（使用较少，海量机器时使用，对运维的架构能力要求较高）<br>/usr/bin/ansible-vault: # Ansible 文件加密工具<br>/usr/bin/ansible-console: # Ansible基于Linux Consoble界面可与用户交互的命令执行工具<br>/usr/share/ansible_plugins:Ansible高级自定义插件目录（需要python基础）<br>/etc/ansible/ansible.cfg:配置文件<br>/etc/ansible/hosts:主机清单</p>
<h2 id="Ansible-配置文件"><a href="#Ansible-配置文件" class="headerlink" title="Ansible 配置文件"></a>Ansible 配置文件</h2><p>　　绝大多数配置保持默认就好<br>1）[defaults]　　<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#inventory      = /etc/ansible/hosts  # 主机列表配置文件</span><br><span class="line">#library       = /usr/share/my_modules/ # 库文件存放目录 </span><br><span class="line">#remote_tmp     = $HOME/.ansible/tmp  # 生成的临时py命令文件存放在远程主机的目录</span><br><span class="line">#local_tmp      = $HOME/.ansible/tmp # 本机的临时命令执行目录</span><br><span class="line">#forks          = 5   # 默认并发数</span><br><span class="line">#poll_interval  = 15   # 默认的线程池</span><br><span class="line">#sudo_user      = root  # 默认sudo 用户</span><br><span class="line">#ask_sudo_pass = True</span><br><span class="line">#ask_pass      = True</span><br><span class="line">#transport      = smart</span><br><span class="line">#remote_port    = 22</span><br><span class="line">#module_lang    = C</span><br><span class="line">#module_set_locale = False</span><br><span class="line"></span><br><span class="line">host_key_checking = False  ### 检查对应服务器的host_key</span><br></pre></td></tr></table></figure></p>
<p>（2）[privilege_escalation]<br>（3）[paramiko_connection]<br>（4）[ssh_connection]<br>（5）[accelerate]<br>（6）[selinux]<br>（7）[colors]</p>
<h2 id="Ansible命令使用说明"><a href="#Ansible命令使用说明" class="headerlink" title="Ansible命令使用说明"></a>Ansible命令使用说明</h2><h3 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>调用ping模块检测node3主机是否存活（node2,3,4能基于主机名通信，且已做过免密钥通信）　　</span><br><span class="line">[root@node2 ~/.ssh]# ansible node3 -m ping </span><br><span class="line">node3 | success &gt;&gt; &#123;</span><br><span class="line">　　"changed": false, </span><br><span class="line">　　"ping": "pong"　　</span><br><span class="line">&#125;</span><br><span class="line">[root@node2 ~/.ssh]# </span><br><span class="line">root@node2 ~/.ssh]# ansible -h　　</span><br><span class="line">Usage: ansible &lt;host-pattern&gt; [options]</span><br><span class="line">Options:</span><br><span class="line">　　-a MODULE_ARGS, --args=MODULE_ARGS    #模块的参数,如果执行默认COMMAND的模块，即是命令参数,如：“date”,"pwd"等等</span><br><span class="line">　　module arguments    #模块参数</span><br><span class="line">　　--ask-become-pass     ask for privilege escalation password # Ansible su切换用户的时候使用该参数输入密码</span><br><span class="line">　　-k, --ask-pass        ask for SSH password  #登录密码，提示输入SSH密码而不是假设基于密钥的验证</span><br><span class="line">　　--ask-su-pass         ask for su password    #su切换密码</span><br><span class="line">　　-K, --ask-sudo-pass   ask for sudo password  #提示密码使用sudo,sudo表示提权操作</span><br><span class="line">　　--ask-vault-pass      ask for vault password  # ansible-valut 加密文件</span><br><span class="line">　　-B SECONDS, --background=SECONDS     #后台运行超时时间</span><br><span class="line">　　run asynchronously, failing after X seconds</span><br><span class="line">　　(default=N/A)</span><br><span class="line">　　-C, --check           don't make any changes; instead, try to predict some    #只是测试一下会改变什么内容，不会真正去执行;相反,试图预测一些可能发生的变化</span><br><span class="line">　　of the changes that may occur</span><br><span class="line">　　-c CONNECTION, --connection=CONNECTION   连接类型使用。可能的选项是paramiko(SSH),SSH和地方。当地主要是用于crontab或启动。</span><br><span class="line">　　connection type to use (default=smart)</span><br><span class="line">　　-e EXTRA_VARS, --extra-vars=EXTRA_VARS  # 调用外部变量</span><br><span class="line">　　-f FORKS, --forks=FORKS    # Ansible一次命令执行并发的线程数,默认是5</span><br><span class="line">　　specify number of parallel processes to use</span><br><span class="line">　　(default=5)</span><br><span class="line">　　-h, --help            show this help message and exit   #打开帮助文档API</span><br><span class="line">　　-i INVENTORY, --inventory-file=INVENTORY    #指定库存主机文件的路径,默认为/etc/ansible/hosts</span><br><span class="line">　　specify inventory host file</span><br><span class="line">　　(default=/etc/ansible/hosts)</span><br><span class="line">　　-l SUBSET, --limit=SUBSET    #进一步限制所选主机/组模式  --limit=192.168.91.135 只对这个ip执行</span><br><span class="line">　　further limit selected hosts to an additional pattern</span><br><span class="line">　　--list-hosts          outputs a list of matching hosts; does not execute</span><br><span class="line">　　anything else</span><br><span class="line">　　-m MODULE_NAME, --module-name=MODULE_NAME   #执行模块的名字，默认使用 command 模块，所以如果是只执行单一命令可以不用 -m参数</span><br><span class="line">　　module name to execute (default=command)</span><br><span class="line">　　-M MODULE_PATH, --module-path=MODULE_PATH    #要执行的模块的路径，默认为/usr/share/ansible/</span><br><span class="line">　　specify path(s) to module library</span><br><span class="line">　　(default=/usr/share/ansible/)</span><br><span class="line">　　-o, --one-line        condense output      #压缩输出，摘要输出.尝试一切都在一行上输出。</span><br><span class="line">　　-P POLL_INTERVAL, --poll=POLL_INTERVAL    #调查背景工作每隔数秒。需要- b</span><br><span class="line">　　set the poll interval if using -B (default=15)</span><br><span class="line">　　--private-key=PRIVATE_KEY_FILE    #私钥路径，使用这个文件来验证连接</span><br><span class="line">　　use this file to authenticate the connection</span><br><span class="line">　　-S, --su              run operations with su    用 su 命令</span><br><span class="line">　　-R SU_USER, --su-user=SU_USER      #指定SU的用户，默认是root用户</span><br><span class="line">　　run operations with su as this user (default=root)</span><br><span class="line">　　-s, --sudo            run operations with sudo (nopasswd)    </span><br><span class="line">　　-U SUDO_USER, --sudo-user=SUDO_USER    #sudo到哪个用户，默认为 root  </span><br><span class="line">　　desired sudo user (default=root)</span><br><span class="line">　　-T TIMEOUT, --timeout=TIMEOUT    #指定SSH默认超时时间，  默认是10S</span><br><span class="line">　　override the SSH timeout in seconds (default=10)</span><br><span class="line">　　-t TREE, --tree=TREE  log output to this directory    #将日志内容保存在该输出目录,结果保存在一个文件中在每台主机上。</span><br><span class="line">　　-u REMOTE_USER, --user=REMOTE_USER    #远程用户， 默认是root用户</span><br><span class="line">　　connect as this user (default=root)</span><br><span class="line">　　--vault-password-file=VAULT_PASSWORD_FILE  </span><br><span class="line">　　vault password file</span><br><span class="line">　　-v, --verbose         verbose mode (-vvv for more, -vvvv to enable    详细信息</span><br><span class="line">　　connection debugging)</span><br><span class="line">　　--version             show program's version number and exit   #输出ansible的版本</span><br></pre></td></tr></table></figure>
<h4 id="Ansiblie命令执行过程-（-vvvv）"><a href="#Ansiblie命令执行过程-（-vvvv）" class="headerlink" title="Ansiblie命令执行过程 （-vvvv）"></a>Ansiblie命令执行过程 （-vvvv）</h4><p>加载自己的配置文件 默认/etc/ansible/ansible.cfg<br>加载自己对应的模块文件，如command<br>通过ansible将模块或命令生成对应的临时py文件，并将该 文件传输至远程服务器的<br>　　对应执行用户的家目录的.ansible/tmp/XXX/XXX.PY文件<br>给文件+x执行<br>执行并返回结果<br>删除临时py文件，sleep 0退出</p>
<h4 id="ansible主机清单的配置"><a href="#ansible主机清单的配置" class="headerlink" title="ansible主机清单的配置"></a>ansible主机清单的配置</h4><p>　　/ect/ansible/hosts,定义方式：</p>
<blockquote>
<p>直接指明主机地址或主机名<br>node3　　<br>172.16.47.104<br>定义一个主机组，把主机地址或主机名写进去，然后通过组名来调用这个组<br>[webservers]　　<br>node3<br>node4<br>如果没有使用公钥，想要使用密码，也可以这样写（适用于第一次登陆控制）<br>格式：【主机名】 【主机地址】 【主机密码】  默认是root用户来进行的　　<br>　　[keepalived]<br>　　keepalived1  ansible_ssh_host=192.168.146.136 ansible_ssh_pass=”test”<br>　　keepalived2  ansible_ssh_host=192.168.146.137 ansible_ssh_pass=”test”<br>ansible-doc<br>　　ansible-doc -l :获取模块信息</p>
</blockquote>
<h2 id="ansible-doc-s-MOD-NAME-获取指定模块的使用帮助"><a href="#ansible-doc-s-MOD-NAME-获取指定模块的使用帮助" class="headerlink" title="ansible-doc -s MOD_NAME: 获取指定模块的使用帮助"></a>ansible-doc -s MOD_NAME: 获取指定模块的使用帮助</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# ansible-doc  -h　　</span><br><span class="line">Usage: ansible-doc [options] [module...]</span><br><span class="line">Show Ansible module documentation     显示Ansible模块文档</span><br><span class="line">Options:</span><br><span class="line">　　--version             show program&apos;s version number and exit    显示ansible-doc的版本号</span><br><span class="line">　　-h, --help            show this help message and exit  显示命令参数API文档</span><br><span class="line">　　-M MODULE_PATH, --module-path=MODULE_PATH   查询模块，--module-path=MODULE_PATH  指定模块的路径</span><br><span class="line">　　Ansible modules/ directory</span><br><span class="line">　　-l, --list            List available modules   显示已存在的所有模块列表</span><br><span class="line">　　-s, --snippet         Show playbook snippet for specified module(s)   显示playbook制定模块的用法</span><br><span class="line">　　-v                    Show version number and exit   显示ansible-doc的版本号</span><br></pre></td></tr></table></figure>
<h2 id="Ansible模块"><a href="#Ansible模块" class="headerlink" title="Ansible模块"></a>Ansible模块</h2><h3 id="command模块"><a href="#command模块" class="headerlink" title="command模块:"></a>command模块:</h3><p>使用ansible自带模块执行命令 如果要用 &gt; &lt; | &amp; ‘ ‘ 使用shell模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~/.ssh]# ansible all -m command -a &quot;ls /root/.ssh&quot;　　</span><br><span class="line">node4 | success | rc=0 &gt;&gt;</span><br><span class="line">authorized_keys</span><br><span class="line">known_hosts</span><br><span class="line">node3 | success | rc=0 &gt;&gt;</span><br><span class="line">authorized_keys</span><br><span class="line">known_hosts</span><br><span class="line">[root@node2 ~/.ssh]#</span><br></pre></td></tr></table></figure>
<p>相关选项如下：　　<br>creates：一个文件名，当该文件存在，则该命令不执行<br>free_form：要执行的linux指令<br>chdir：在执行指令之前，先切换到该目录<br>removes：一个文件名，当该文件不存在，则该选项不执行<br>executable：切换shell来执行指令，该执行路径必须是一个绝对路径</p>
<h3 id="shell-模块"><a href="#shell-模块" class="headerlink" title="shell 模块:"></a>shell 模块:</h3><p>调用bash执行命令 类似 cat /tmp/stanley.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; /tmp/stanley.txt 这些复杂命令，即使使用shell也会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器（执行Ansible命令的机器往往称为：Master机或者中控机或者堡垒机）。</p>
<p>　　注意：command和shell模块的核心参数直接为命令本身；而其它模块的参数通常为“key=value”格式；’’</p>
<h3 id="copy模块："><a href="#copy模块：" class="headerlink" title="copy模块："></a>copy模块：</h3><p>复制本地文件至远程服务器，并且能够改属性等</p>
<p>直接复制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible  all -m copy -a &quot;src=txt dest=/tmp mode=540&quot;</span><br></pre></td></tr></table></figure>
<p>生成内容的复制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible  all -m copy -a &quot;content=&apos;hellow&apos; dest=/tmp/test mode=540&quot;</span><br><span class="line">ansible  all -m shell -a &quot;cat /tmp/test mode=540&quot;</span><br></pre></td></tr></table></figure>
<p>注意：这两种方法是互斥的，即src和content不能同时使用<br>相关选项如下：　　<br>backup：在覆盖之前，将源文件备份，备份文件包含时间信息。有两个选项：yes|no<br>content：用于替代“src”，可以直接设定指定文件的值<br>dest：必选项。要将源文件复制到的远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录<br>directory_mode：递归设定目录的权限，默认为系统默认权限<br>force：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes<br>others：所有的file模块里的选项都可以在这里使用<br>src：被复制到远程主机的本地文件，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用“/”来结尾，则只复制目录里的内容，如果没有使用“/”来结尾，则包含目录在内的整个内容全部复制，类似于rsync。</p>
<h3 id="file模块："><a href="#file模块：" class="headerlink" title="file模块："></a>file模块：</h3><p>设置文件属性</p>
<p>-a “path=PATH state=directory”  # 创建目录　　</p>
<figure class="highlight plain"><figcaption><span>~]# ansible all -m file -a "path</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>　　</p>
<p>-a “path=PATH  src=FILE  state=link”    #创建链接文件<br>　　<br>[root@node2 ~]# ansible all -m file -a “path=/root/haha src=/tmp/hehe state=link” </p>
<p>-a “path=PATH  state=absent”    #删除文件<br>[root@node2 ~]# ansible all -m file -a “path=/root/haha state=absent”</p>
<p>　　相关选项如下：<br>force：需要在两种情况下强制创建软链接，一种是源文件不存在，但之后会建立的情况下；另一种是目标软链接已存在，需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no　　</p>
<p>group：定义文件/目录的属组<br>mode：定义文件/目录的权限<br>owner：定义文件/目录的属主<br>path：必选项，定义文件/目录的路径<br>recurse：递归设置文件的属性，只对目录有效<br>　　<br>src：被链接的源文件路径，只应用于state=link的情况<br>　　<br>dest：被链接到的路径，只应用于state=link的情况<br>　　<br>state：<br>　　directory：如果目录不存在，就创建目录<br>　　file：即使文件不存在，也不会被创建<br>　　link：创建软链接<br>　　hard：创建硬链接<br>　　touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间<br>　　absent：删除目录、文件或者取消链接文件
　　</p>
<p>　　fetch模块： 从远程服务器拉取文件至本机，只能fetch文件，不能fetch目录,如果拉目录，先tar/zip 再拉到本机即可<br>　　<br>[root@node2 ~]# ansible all -m fetch -a “src=/tmp/txt dest=/root/txt.txt”<br>　　cron模块: 管理cron计划任务<br>　　<br>[root@node2 ~]# ansible all -m corn -a “minute=’*/5’ job=’/usr/sbin/ntpdate 172.16.0.1 &amp;&gt; /dev/null’ name=’Synctime’” #每5分钟同步一下时间<br>　　<br>[root@node2 ~]# ansible all -m corn -a “state=absent name=’Synctime’” #删除上面的定时任务<br>　　相关选项如下：
　　</p>
<ul>
<li>a “”: 设置管理节点生成定时任务　　<br>action: cron</li>
</ul>
<p>backup=    # 如果设置，创建一个crontab备份<br>　　<br>cron_file=          #如果指定, 使用这个文件cron.d，而不是单个用户crontab<br>　　<br>day=       # 日应该运行的工作( 1-31, <em>, </em>/2, etc )<br>　　<br>hour=      # 小时 ( 0-23, <em>, </em>/2, etc )<br>　　<br>job=       #指明运行的命令是什么<br>　　<br>minute=    #分钟( 0-59, <em>, </em>/2, etc )<br>　　<br>month=     # 月( 1-12, <em>, </em>/2, etc )<br>　　<br>name=     #定时任务描述<br>　　<br>reboot    # 任务在重启时运行，不建议使用，建议使用special_time<br>　　<br>special_time       # 特殊的时间范围，参数：reboot（重启时）,annually（每年）,monthly（每月）,weekly（每周）,daily（每天）,hourly（每小时）
　　</p>
<p>state        #指定状态，prsent表示添加定时任务，也是默认设置，absent表示删除定时任务
　　</p>
<p>user         # 以哪个用户的身份执行<br>　　<br>weekday      # 周 ( 0-6 for Sunday-Saturday, *, etc )
　　</p>
<p>　　yum模块：yum安装软件，也有apt,zypper
　　</p>
<p>[root@node2 ~]# ansible all -m yum -a “name=httpd state=latest” #安装httpd包　　</p>
<p>　　相关选项如下：
　　</p>
<p>conf_file         #设定远程yum安装时所依赖的配置文件。如配置文件没有在默认的位置。　　<br>disable_gpg_check    #是否禁止GPG checking，只用于<code>present&#39; or</code>latest’。<br>　　<br>disablerepo   #临时禁止使用yum库。 只用于安装或更新时。<br>　　<br>enablerepo    #临时使用的yum库。只用于安装或更新时。<br>　　<br>name=            #所安装的包的名称<br>　　<br>state               #present安装， latest安装最新的, absent 卸载软件。<br>　　<br>update_cache  #强制更新yum的缓存。
　　</p>
<p>　　service模块: 服务程序管理
　　</p>
<p>[root@node2 ~]# ansible all -m service -a “name=httpd state=restarted”  #重启httpd　　<br>[root@node2 ~]# ansible all -m service -a “name=httpd  enabled=true”    #开机启动
　　</p>
<p>　　相关选项如下：
　　</p>
<p>arguments         #命令行提供额外的参数　　<br>enabled           #设置开机启动。<br>　　<br>name=             #服务名称<br>　　<br>runlevel          #开机启动的级别，一般不用指定。<br>　　<br>sleep             #在重启服务的过程中，是否等待。如在服务关闭以后等待2秒再启动。</p>
<p>state     #started启动服务， stopped停止服务， restarted重启服务，&gt;　　</p>
<p>　　group模块: 组管理
　　</p>
<p>[root@node2 ~]# ansible-doc -s group　　</p>
<ul>
<li>name: 添加或删除组</li>
</ul>
<p>action: group<br>　　<br>gid       # 设置组的GID号<br>　　<br>name=     # 管理组的名称<br>　　<br>state     # 指定组状态，默认为创建，设置值为absent为删除<br>　　<br>system    # 设置值为yes，表示为创建系统组
　　</p>
<p>　　User模块:用户管理
　　</p>
<p>-a “”　　<br>action: user<br>　　<br>comment    # 用户的描述信息<br>　　<br>createhom  # 是否创建家目录<br>　　<br>force      # 在使用<code>state=absent&#39;是, 行为与</code>userdel –force’一致.<br>　　<br>group      # 指定基本组<br>　　<br>groups     # 指定附加组，如果指定为(‘groups=’)表示删除所有组<br>　　<br>home       # 指定用户家目录<br>　　<br>login_class     #可以设置用户的登录类 FreeBSD, OpenBSD and NetBSD系统.<br>　　<br>move_home       # 如果设置为<code>home=&#39;时, 试图将用户主目录移动到指定的目录
　　
name=           # 指定用户名
　　
non_unique      # 该选项允许改变非唯一的用户ID值
　　
password        # 指定用户密码
　　
remove          # 在使用</code>state=absent’时, 行为是与 `userdel –remove’一致.<br>　　<br>shell           # 指定默认shell<br>　　<br>state           #设置帐号状态，不指定为创建，指定值为absent表示删除<br>　　<br>system          # 当创建一个用户，设置这个用户是系统用户。这个设置不能更改现有用户。<br>　　<br>uid             #指定用户的uid<br>update_password  # 更新用户密码<br>expires         #指明密码的过期时间<br>ansible all -m user -a ‘name=magedu home=/tmp/magedu/ shell=/bin/bash uid=2000 comment=”test user” group=root’
　　</p>
<p>　　ping 模块： 检测主机存活<br>　　setup模块：获取指定主机的facts。<br>　　<br>facts就是变量，内建变量 。每个主机的各种信息，cpu颗数、内存大小等。会存在facts中的某个变量中。调用后返回很多对应主机的信息，在后面的操作中可以根据不同的信息来做不同的操作。如redhat系列用yum安装，而debian系列用apt来安装软件。
　　</p>
<p>ansible node3 -m setup　　</p>
<p>　　selinux模块： 管理selinux<br>　　<br>关闭selinux
　　</p>
<p>ansible all -m selinux -a ‘state=disabled’　　</p>
<p>conf     #指定应用selinux的配置文件。　　<br>state=enforcing|permissive|disabled      #对应于selinux配置文件的SELINUX。<br>　　<br>policy=targeted|minimum|mls     #对应于selinux配置文件的SELINUXTYPE
　　</p>
<p>　　script模块：发送脚本到各被管理节点，并执行;不需要参数
　　</p>
<p>ansible all -m script -a ‘test.sh’ #直接在-a 后面指定脚本即可　　</p>
<p>　　未完待续……<br>　　最后打个广告，Stanley老师的Ansible权威指南，你，值得拥有</p>
<p>DSC0007.png (64.81 KB, 下载次数: 0)</p>
<p>下载附件  保存到相册</p>
<p>2017-6-9 08:59 上传</p>

        </div>
        <div class="post-reply">
            
                <!-- 来必力City版安装代码 -->
                <div id="lv-container" data-id="city" data-uid="MTAyMC8zNTYwOC8xMjE0NA">
                    <script type="text/javascript">
                        (function(d, s) {
                            var j, e = d.getElementsByTagName(s)[0];

                            if (typeof LivereTower === 'function') { return; }

                            j = d.createElement(s);
                            j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                            j.async = true;

                            e.parentNode.insertBefore(j, e);
                        })(document, 'script');
                    </script>
                    <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
                </div>
                <!-- City版安装代码已完成 -->
            
            
            <div id="disqus_thread" style="width: 80%; margin: 0 auto;"></div>
                <script>

                    /**
                     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                    /*
                     var disqus_config = function () {
                     this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
                     this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                     };
                     */
                    (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');
                        s.src = 'https://haojen.disqus.com/embed.js';
                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            
        </div>
    </div>
</section>
<script>
    // 获取第一张图, 用以当封面背景图
    var img = document.querySelectorAll('img')[1]

    if (img) {
        var header_box = document.querySelector('#header_box')
        header_box.style.backgroundImage = 'url('+ img.src +')'
    }
</script>
      </div>
  </div>
  <style>
  #footer {
    min-height: 10vh;
    background: black;
    color: #fff;
  }

  #footer a {
    color: #e1e1e1;
  }
</style>
<footer id="footer" class="has-text-centered is-flex center">
  <div class="container has-padding">
    <div>
      <div>
        <!--请您保留作者署名, 主题制作来之不易-->
        Theme by <a href="http://haojen.github.io/">Haojen Ma</a>
        <br>
        Copyright © Lucas 2018
        <br>
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      </div>
    </div>
  </div>
</footer>

<script src="/js/search_core.js"></script>
<script src="/js/script.js"></script>

</body>
</html>